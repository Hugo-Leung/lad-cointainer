Bootstrap: docker
From: almalinux:9 

%arguments
	DEF_HASH=""

%setup
mkdir ${APPTAINER_ROOTFS}/w
mkdir ${APPTAINER_ROOTFS}/volatile
mkdir ${APPTAINER_ROOTFS}/cache
mkdir ${APPTAINER_ROOTFS}/scratch
mkdir ${APPTAINER_ROOTFS}/cvmfs
wget https://pki.jlab.org/JLabCA.crt -O  ${APPTAINER_ROOTFS}/etc/pki/ca-trust/source/anchors/JLabCA.crt


%files 
	./dnf.sh /dnf.sh
	./packages /packages
	./root.sh /root.sh
	./hcana.sh /hcana.sh
	./ladlib.sh /ladlib.sh
%post
	ln -s /w/work /work
	update-ca-trust
	bash /dnf.sh
	bash /root.sh
	bash /hcana.sh
	bash /ladlib.sh
	NOW=`date`
	
	rm /dnf.sh /root.sh /hcana.sh /ladlib.sh /packages
	echo "LADLIB_HASH $(git -C /opt/LADlib-src rev-parse --short HEAD)" >> $APPTAINER_LABELS
	echo "HCANA_HASH $(git -C /opt/hcana-src rev-parse --short HEAD)" >> $APPTAINER_LABELS
	
%environment
	export ROOTSYS=/opt/root
	export PATH=$ROOTSYS/bin:$PATH
	export PYTHONPATH=$ROOTSYS/lib:$PYTHONPATH
	export CLING_STANDARD_PCH=none

	export PATH=/opt/hcana/bin:$PATH
	export LD_LIBRARY_PATH=/opt/LADlib/lib64/:$LD_LIBRARY_PATH
	export ROOT_INCLUDE_PATH=/opt/LADlib/include:/opt/hcana/include:$ROOT_INCLUDE_PATH
%runscript
	hcana "$@"

%test 
	hcana -v
	if [ $? -eq 0 ]; then
        echo "hcana is running sucessfully."
    else
        echo "Build failed."
        exit 1
    fi
	hcana -l -b -q -e "gSystem->Load(\"libLAD\")"
	if [ $? -eq 0 ]; then
        echo "LADlib is loaded sucessfully."
    else
        echo "Build failed."
        exit 2
    fi

%labels
	DEF_HASH {{ DEF_HASH }}
